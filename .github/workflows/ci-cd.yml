name: ğŸš€ YeÅŸer EAS-Native CI/CD Pipeline

on:
  push:
    branches: [main, develop, feature/premium-payment-integration]
  pull_request:
    branches: [main, develop]
  workflow_dispatch: # Allow manual triggering
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'preview'
        type: choice
        options:
          - preview
          - production
      deploy_to_stores:
        description: 'Deploy to app stores after build'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  CACHE_VERSION: 'v6'

jobs:
  # ğŸ” Basic Code Quality (Let EAS handle deep validation)
  quality-check:
    name: ğŸ¯ Code Quality Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm ci --prefer-offline --no-audit
        env:
          CI: true

      - name: ğŸ¯ TypeScript Check
        run: |
          echo "Running TypeScript compilation check..."
          npm run type-check

      - name: ğŸ”§ ESLint Check
        run: |
          echo "Running ESLint analysis..."
          npm run lint:check

      - name: ğŸ† Quality Summary
        run: |
          echo "âœ… Basic quality checks passed!"
          echo "ğŸš€ EAS Build will handle comprehensive validation"

  # ğŸš€ EAS Build Pipeline - Preview
  build-preview:
    name: ğŸ“± EAS Build Preview
    runs-on: ubuntu-latest
    needs: quality-check
    if: github.ref == 'refs/heads/develop' || contains(github.ref, 'feature/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'preview')
    timeout-minutes: 60
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ”¨ EAS Build Preview
        run: |
          echo "ğŸš€ Starting EAS Build for preview..."
          echo "ğŸ“± EAS will handle all validation, dependencies, and building"
          eas build --platform all --profile preview --non-interactive

      - name: ğŸ“± Build Success
        run: |
          echo "ğŸ‰ EAS Preview build completed!"
          echo "ğŸ“± Builds available on EAS dashboard for testing"

  # ğŸŒŸ EAS Build Pipeline - Production
  build-production:
    name: ğŸš€ EAS Build Production
    runs-on: ubuntu-latest
    needs: quality-check
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    timeout-minutes: 90
    
    outputs:
      should-deploy: ${{ steps.check-deploy.outputs.should-deploy }}
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ”¨ EAS Build Production
        run: |
          echo "ğŸš€ Starting EAS Build for production..."
          echo "ğŸ“¦ Building for App Store submission"
          echo "ğŸ EAS will handle all validation, credentials, and building"
          eas build --platform all --profile production --non-interactive

      - name: ğŸ¯ Check Deploy Conditions
        id: check-deploy
        run: |
          if [[ "${{ github.event.head_commit.message }}" == *"[deploy]"* ]] || [[ "${{ github.event.inputs.deploy_to_stores }}" == "true" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "ğŸš¢ Deployment conditions met - will proceed to app store submission"
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Build completed - no deployment trigger found"
          fi

      - name: ğŸ† Production Build Success
        run: |
          echo "ğŸš€ EAS Production build completed successfully!"
          echo "ğŸ“¦ Ready for app store submission"

  # ğŸš¢ EAS Submit Pipeline
  deploy-production:
    name: ğŸš¢ EAS Submit to App Stores
    runs-on: ubuntu-latest
    needs: build-production
    if: needs.build-production.outputs.should-deploy == 'true'
    timeout-minutes: 30

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸš€ EAS Submit to App Stores
        run: |
          echo "ğŸš¢ Starting EAS Submit to app stores..."
          echo "ğŸ iOS: Submitting to App Store Connect"
          echo "ğŸ¤– Android: Submitting to Google Play Console"
          eas submit --platform all --profile production --non-interactive

      - name: ğŸ¯ Deployment Success
        run: |
          echo "ğŸ‰ EAS Submit completed!"
          echo "ğŸ“± App submitted to both app stores via EAS!"
          echo "â±ï¸  Review times: iOS (24-48 hours), Android (2-3 hours)"

  # ğŸ” Security Scan (Keep minimal)
  security-scan:
    name: ğŸ›¡ï¸ Security Check
    runs-on: ubuntu-latest
    needs: quality-check
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ›¡ï¸ Security Audit
        run: |
          echo "Running security audit..."
          npm run audit:security

  # ğŸ¯ Workflow Summary
  workflow-completion:
    name: ğŸ¯ Pipeline Summary
    runs-on: ubuntu-latest
    needs: [quality-check, build-preview, build-production, security-scan, deploy-production]
    if: always()
    
    steps:
      - name: ğŸ“Š Workflow Summary
        run: |
          echo "ğŸ¯ EAS-Native CI/CD Pipeline Summary"
          echo "===================================="
          echo "Quality Check: ${{ needs.quality-check.result }}"
          echo "Preview Build: ${{ needs.build-preview.result }}"
          echo "Production Build: ${{ needs.build-production.result }}"
          echo "Security Scan: ${{ needs.security-scan.result }}"
          echo "Deployment: ${{ needs.deploy-production.result }}"
          echo "===================================="
          
          if [[ "${{ needs.deploy-production.result }}" == "success" ]]; then
            echo "ğŸš€ DEPLOYMENT SUCCESSFUL! App submitted via EAS."
          elif [[ "${{ needs.build-production.result }}" == "success" ]]; then
            echo "ğŸ“¦ BUILD SUCCESSFUL! Ready for EAS Submit."
          else
            echo "ğŸ”„ Pipeline completed. EAS handles all deep validation."
          fi

      - name: ğŸš€ EAS-Native Success
        run: |
          echo "âœ… Fully EAS-Native CI/CD Pipeline!" 
          echo "ğŸ¯ All validation, building, and deployment handled by EAS"
          echo "ğŸ“± No custom scripts needed - EAS is the complete solution" 