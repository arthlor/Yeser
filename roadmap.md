# Push Notification System Implementation Roadmap

This document outlines the step-by-step plan to implement a robust push notification system using Expo and Supabase.

## **Phase 1: Client-Side Setup & Token Management**

This phase focuses on configuring the React Native application to handle push notification permissions and tokens.

### 1.1: Install Dependencies (Agent) - [COMPLETED]

- I have installed the `expo-notifications` library into the project.

### 1.2: Configure Firebase for Android (Manual - User Action)

**Why:** Android requires a Firebase project to use Firebase Cloud Messaging (FCM), which powers push notifications.

- **Action:**
  1. Go to the [Firebase Console](https://console.firebase.google.com/).
  2. Create a new Firebase project (or use an existing one).
  3. Add an Android app to the project. The package name must match `android.package` in your `app.config.js`.
  4. Download the generated `google-services.json` file.
  5. Place this file in the root directory of this project. It is already in the `.gitignore`.
  6. In the Firebase Console, go to "Project Settings" -> "Cloud Messaging" and ensure the "Firebase Cloud Messaging API" is enabled.

### 1.3: Configure APNs for iOS (Manual - User Action)

**Why:** iOS requires an Apple Push Notification service (APNs) key to send notifications.

- **Action:**
  1. Go to your [Apple Developer Account](https://developer.apple.com/account/).
  2. Navigate to "Certificates, Identifiers & Profiles" and then "Keys".
  3. Create a new key with the "Apple Push Notifications service (APNs)" capability enabled.
  4. Download the `.p8` key file. **This can only be downloaded once.**
  5. In the **Expo Dashboard**, navigate to your project -> Credentials -> "Application Identifier" and follow the instructions to upload your APNs key. This will securely manage it for your builds.

### 1.4: Update App Configuration (Agent) - [COMPLETED]

- I have updated `app.config.js` to include the necessary `expo-notifications` plugin and Android configuration to link to the `google-services.json` file.

### 1.5: Create Supabase `push_notifications` Table (Manual - User Action) - [COMPLETED]

**Why:** We need a dedicated table to store push notification tokens for each user, allowing us to send targeted notifications.

- **Action:** You have run the following SQL script in the Supabase SQL Editor:

```sql
CREATE TABLE public.push_notifications (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    push_token TEXT NOT NULL UNIQUE,
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    device_info JSONB
);

-- Enable Row Level Security
ALTER TABLE public.push_notifications ENABLE ROW LEVEL SECURITY;

-- Create policy for users to manage their own tokens
CREATE POLICY "Allow users to manage their own push tokens"
ON public.push_notifications
FOR ALL
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);
```

### 1.6: Implement Client-Side Logic (Agent) - [COMPLETED]

- **`usePushNotifications` Hook:** I have created the `src/hooks/usePushNotifications.ts` hook. This hook manages permission requests, retrieving the `ExpoPushToken`, handling deep linking, and unregistering.
- **API Integration:** I have added functions to `src/api/profileApi.ts` to save and remove push tokens from the database.
- **App Integration:** The `usePushNotifications` hook is integrated into the app's core logic to register the device token upon user login and handle notification interactions.

## **Phase 2: Backend Sending Logic (Supabase)**

This phase focuses on creating the server-side logic required to trigger and send notifications.

### 2.1: Create Supabase Edge Functions (Agent) - [COMPLETED]

- I have created the following Supabase Edge Functions in the `supabase/functions/` directory:
  - `send-push-notification`: A generic, reusable function that takes a list of messages and sends them to the Expo Push API.
  - `daily-reminder`: A function that queries for users who have reminders enabled and calls the sending service.
  - `throwback-notification`: A daily function to find and send "on this day" style notifications.

### 2.2: Set up Daily Cron Jobs (Manual - User Action)

**Why:** We need scheduled tasks to run automatically every day.

- **Action:** In the Supabase Dashboard, go to "Database" -> "Cron Jobs" and create a new job for each function:
  - **Daily Reminder Job:**
    - **Name:** Daily Reminder
    - **Schedule:** `0 20 * * *` (8:00 PM UTC - adjust as needed).
    - **Function:** `daily-reminder`
  - **Throwback Job:**
    - **Name:** Daily Throwback
    - **Schedule:** `0 14 * * *` (2:00 PM UTC - adjust as needed).
    - **Function:** `throwback-notification`

## **Phase 3: User Interface & Control**

This phase focuses on giving users control over their notification preferences.

### 3.1: Implement Notification Settings UI (Agent) - [COMPLETED]

- I have created a new `NotificationSettings.tsx` component that contains a toggle switch for enabling/disabling daily reminders.
- I have added this component to a dedicated "Notifications" section in `SettingsScreen.tsx`.
- The toggle switch is connected to the user's profile settings. We added an `enable_reminders` column to the `profiles` table to control this.

## **Phase 4: Testing & Validation**

This phase is a joint effort to ensure the entire system works end-to-end.

### 4.1: End-to-End Testing (Agent & User)

**Crucial:** Push notifications **cannot be tested on a simulator/emulator.** A physical Android or iOS device is required.

- **Action (User):**
  1. Build the app for your physical device using `eas build`.
  2. Install the build and log in.
  3. Enable notifications via the new settings toggle.
- **Action (Agent & User):**
  1. **Verify Token:** Check the `push_notifications` table in Supabase to confirm your device token was saved.
  2. **Test Reminder Notification:** In the Supabase dashboard, manually invoke the `daily-reminder` cron job to test the reminder flow.
  3. **Test Throwback Notification:** Manually invoke the `throwback-notification` cron job to test the throwback flow.
  4. **Test Opt-Out:** Disable notifications in the settings and verify the token is removed from the database. Trigger a notification again and confirm you do not receive it.

---

We have made excellent progress. Please complete the remaining "Manual - User Action" steps to finalize the implementation.
